name: Deploy ACUL to Vercel

on:
Â  push:
Â  Â  branches:
Â  Â  Â  - main
Â  pull_request:
Â  Â  branches:
Â  Â  Â  - main
Â  workflow_dispatch:

env:
Â  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
Â  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
Â  deploy:
Â  Â  runs-on: ubuntu-latest
Â  Â  
Â  Â  steps:
Â  Â  Â  - name: ðŸ“¥ Checkout code
Â  Â  Â  Â  uses: actions/checkout@v4

Â  Â  Â  - name: ðŸ”§ Setup Node.js
Â  Â  Â  Â  uses: actions/setup-node@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  node-version: '20'

Â  Â  Â  - name: ðŸ“¦ Install dependencies
Â  Â  Â  Â  working-directory: auth0-acul-samples/react-js
Â  Â  Â  Â  run: npm ci

Â  Â  Â  - name: ðŸ—ï¸ Build ACUL assets
Â  Â  Â  Â  working-directory: auth0-acul-samples/react-js
Â  Â  Â  Â  run: npm run build

Â  Â  Â  - name: ðŸ“‹ List built assets
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "Built assets:"
Â  Â  Â  Â  Â  ls -lah auth0-acul-samples/react-js/dist/assets/

Â  Â  Â  - name: ðŸ“„ Copy vercel.json to dist folder
Â  Â  Â  Â  run: cp auth0-acul-samples/vercel.json auth0-acul-samples/react-js/dist/

Â  Â  Â  - name: ðŸš€ Install Vercel CLI
Â  Â  Â  Â  run: npm install --global vercel@latest

Â  Â  Â  - name: ðŸš¢ Deploy to Vercel
Â  Â  Â  Â  id: deploy
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  # FIX: Deploy the specific folder (the build output) from the repository root.
Â  Â  Â  Â  Â  # This prevents Vercel from incorrectly combining paths.
Â  Â  Â  Â  Â  DEPLOYMENT_URL=$(vercel deploy \
Â  Â  Â  Â  Â  Â  auth0-acul-samples/react-js/dist \
Â  Â  Â  Â  Â  Â  --prebuilt \
Â  Â  Â  Â  Â  Â  --prod \
Â  Â  Â  Â  Â  Â  --token=${{ secrets.VERCEL_TOKEN }})
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  echo "Deployed to: $DEPLOYMENT_URL"
Â  Â  Â  Â  Â  echo "url=https://auth0-acul-samples.vercel.app" >> $GITHUB_OUTPUT

Â  Â  Â  - name: ðŸ”„ Update Auth0 Configuration
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
Â  Â  Â  Â  Â  AUTH0_MGMT_TOKEN: ${{ secrets.AUTH0_MGMT_TOKEN }}
Â  Â  Â  Â  Â  VERCEL_URL: "https://auth0-acul-samples.vercel.app"
Â  Â  Â  Â  run: node auth0-acul-samples/scripts/update-auth0-vercel.js

Â  Â  Â  - name: âœ… Deployment Complete
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "================================"
Â  Â  Â  Â  Â  echo "ðŸŽ‰ Deployment Successful!"
Â  Â  Â  Â  Â  echo "================================"
Â  Â  Â  Â  Â  echo "ðŸ”— Live URL: https://auth0-acul-samples.vercel.app"
Â  Â  Â  Â  Â  echo "================================"

Â  Â  Â  - name: ðŸ’¬ Comment PR with Deployment URL
Â  Â  Â  Â  if: github.event_name == 'pull_request'
Â  Â  Â  Â  uses: actions/github-script@v7
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  script: |
Â  Â  Â  Â  Â  Â  github.rest.issues.createComment({
Â  Â  Â  Â  Â  Â  Â  issue_number: context.issue.number,
Â  Â  Â  Â  Â  Â  Â  owner: context.repo.owner,
Â  Â  Â  Â  Â  Â  Â  repo: context.repo.repo,
Â  Â  Â  Â  Â  Â  Â  body: `## ðŸš€ ACUL Deployed to Vercel

Â  Â  Â  Â  Â  Â  Â  **Deployment URL:** https://auth0-acul-samples.vercel.app
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  âœ… Auth0 configuration has been updated automatically.
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  ### Test the deployment:
Â  Â  Â  Â  Â  Â  Â  1. Go to your Auth0 application
Â  Â  Â  Â  Â  Â  Â  2. Click the login button
Â  Â  Â  Â  Â  Â  Â  3. You should see your customized ACUL screen
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  ---
Â  Â  Â  Â  Â  Â  Â  Deployment triggered by: @${{ github.actor }}`
Â  Â  Â  Â  Â  Â  })